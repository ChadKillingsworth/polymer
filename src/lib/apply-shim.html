<!--
@license
Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="style-util.html">
<script>
Polymer.ApplyShim = (function(){
  'use strict';

  var styleUtil = Polymer.StyleUtil;

  var MIXIN_MATCH = styleUtil.rx.MIXIN_MATCH;
  var VAR_ASSIGN = styleUtil.rx.VAR_ASSIGN;
  var VAR_MATCH = styleUtil.rx.VAR_MATCH;
  var APPLY_NAME_CLEAN = /;\s*/m;

  // map of mixin to property names
  // --foo: {border: 2px} -> (--foo, {border: '2px'})
  var mixinMap = Object.create(null);

  function mapSet(name, prop) {
    name = name.trim();
    var old = mixinMap[name];
    if (old) {
      var reset = diff(old, prop);
      reset.forEach(function(r) {
        prop[r] = 'initial';
      })
    }
    mixinMap[name] = prop;
  }

  // get(--foo) -> '--foo-border: 2px;'
  function mapGet(name) {
    name = name.trim();
    return mixinMap[name];
  }

  function diff(oldProp, newProp) {
    var diff = [];
    Object.keys(oldProp).forEach(function(p) {
      if (!newProp[p]) {
        diff.push(p);
      }
    });
    return diff;
  }

  function flattenMixin(name, props) {
    return Object.keys(props).map(function(p){
      return name + '-' + p + ':' + props[p];
    }).join(';') + ';';
  }

  function applyVars(name, props, defaults) {
    return Object.keys(props).map(function(p){
      var fallback = defaults && defaults[p];
      var parts = [p, ': var(', name, '-', p];
      if (fallback) {
        parts.push(',', fallback);
      }
      parts.push(')');
      return parts.join('');
    }).join('; ');
  }

  function textToProps(text) {
    var props = text.split(';');
    var out = {};
    for (var i = 0, p, sp; i < props.length; i++) {
      p = props[i];
      if (p) {
        sp = p.split(':');
        if (sp.length >= 2) {
          out[sp[0].trim()] = sp.slice(1).map(function(n) {
            return n.trim();
          }).join(':');
        }
      }
    }
    return out;
  }

  function assign(all, name, property, mixin) {
    // handle case where property value is a mixin
    if (property) {
      property.replace(VAR_MATCH, function(all, prefix, value){
        if (mapGet(value)){
          mixin = '@apply ' + value + ';';
        }
      });
    }
    if (!mixin) {
      return all;
    }
    var defaults = collectDefaults(mixin);
    mixin = mixin.replace(MIXIN_MATCH, function(all, name) {
      return apply(all, name, defaults);
    });
    var prefix = all.slice(0, all.indexOf('--'));
    var subprops = textToProps(mixin);
    mapSet(name, subprops);
    return prefix + flattenMixin(name, subprops);
  }

  function apply(all, name, defaults) {
    var prefix = all.slice(0, all.indexOf('@apply'));
    name = name.replace(APPLY_NAME_CLEAN, '');
    var mixin = mapGet(name);
    var vars = '';
    if (mixin) {
      vars = applyVars(name, mixin, defaults) + ';';
    }
    return prefix + vars;
  }

  function collectDefaults(cssText) {
    return textToProps(cssText.replace(MIXIN_MATCH,
      function(all) {
        return all.slice(0, all.indexOf('@apply'));
      })
    );
  }

  // fix shim'd var syntax
  // var(--a, --b) -> var(--a, var(--b));
  function fixVars(all, prefix, value, fallback) {
    if (!fallback || fallback.indexOf('--') !== 0) {
      return all;
    }
    return prefix + 'var(' + value + ',var(' + fallback + '));';
  }

  return {
    transform: function(styles) {
      styleUtil.forRulesInStyles(styles, this.transformRule.bind(this));
    },
    transformRule: function(rule) {
      rule.cssText = this.transformCssText(rule.parsedCssText);
      // :root was only used for variable assignment in property shim,
      // but generates invalid selectors with real properties.
      // replace with `:host > *`, which serves the same effect
      if (rule.selector === ':root') {
        rule.selector = ':host > *';
      }
    },
    transformCssText: function(cssText) {
      // fix shim variables
      cssText = cssText.replace(VAR_MATCH, fixVars);
      // produce variables
      cssText = cssText.replace(VAR_ASSIGN, assign);
      var defaults = collectDefaults(cssText);
      // consume mixins
      cssText = cssText.replace(MIXIN_MATCH, function(all, name) {
        return apply(all, name, defaults);
      });
      return cssText;
    }
  };
})();
</script>

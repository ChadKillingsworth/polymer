<!--
@license
Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../lib/style-properties.html">
<link rel="import" href="../lib/settings.html">
<link rel="import" href="../lib/style-defaults.html">
<link rel="import" href="../lib/style-cache.html">
<link rel="import" href="../lib/style-util.html">
<script>
Polymer.ApplyShim = (function(){
  'use strict';

  var propertyUtils = Polymer.StyleProperties;
  var styleTransformer = Polymer.StyleTransformer;
  var styleDefaults = Polymer.StyleDefaults;
  var styleUtil = Polymer.StyleUtil;

  // map of mixin to property names
  // --foo: {border: 2px} -> (--foo, {border: '2px'})
  var mixinMap = Object.create(null);

  function mapSet(name, prop) {
    var old = mixinMap[name];
    if (old) {
      var reset = diff(old, prop);
      reset.forEach(function(r) {
        prop[r] = 'initial';
      })
    }
    mixinMap[name] = prop;
  }

  // get(--foo) -> '--foo-border: 2px;'
  function mapGet(name) {
    return mixinMap[name];
  }

  function diff(oldProp, newProp) {
    var diff = [];
    Object.keys(oldProp).forEach(function(p) {
      if (!newProp[p]) {
        diff.push(p);
      }
    });
    return diff;
  }

  function flattenMixin(name, props) {
    return Object.keys(props).map(function(p){
      return name + '-' + p + ': ' + props[p];
    }).join('; ');
  }

  function applyVars(name, props) {
    return Object.keys(props).map(function(p){
      return p + ': var(' + name + '-' + p + ')';
    }).join('; ');
  }

  function textToProps(text) {
    var props = text.split(';');
    var out = {};
    for (var i = 0, p, sp; i < props.length; i++) {
      p = props[i];
      if (p) {
        sp = p.split(':');
        if (sp.length >= 2) {
          out[sp[0].trim()] = sp.slice(1).map(function(n) {
            return n.trim();
          }).join(':');
        }
      }
    }
    return out;
  }

  return {
    transform: function(styles) {
      styleUtil.forRulesInStyles(styles, function(n){
        var cssText = n.cssText;
        // produce variables
        cssText = cssText.replace(propertyUtils.rx.VAR_ASSIGN,
          function(all, name, _, mixin) {
            if (!mixin) {
              return all;
            }
            var prefix = all.slice(0, all.indexOf('--'));
            name = name.trim();
            var subprops = textToProps(mixin);
            mapSet(name, subprops);
            return prefix + flattenMixin(name, subprops);
          });
        // consume mixins
        cssText = cssText.replace(propertyUtils.rx.MIXIN_MATCH,
          function(all, name) {
            var prefix = all.slice(0, all.indexOf('@apply'));
            name = name.replace(/;$/, '');
            var mixin = mapGet(name);
            var vars = '';
            if (mixin) {
              vars = applyVars(name, mixin) + ';';
            }
            return prefix + vars;
          });
        n.cssText = cssText;
      }, function(n){
        console.log(n);
      });
    }
  };
})();
</script>
